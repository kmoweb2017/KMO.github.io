<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0d0d0d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="KMO Finance">
<title>KMO RACK BAR CUSTOM ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
<link rel="manifest" href="data:application/json,{%22name%22:%22KMO Finance%22,%22short_name%22:%22KMO%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%230d0d0d%22,%22theme_color%22:%22%23f5a623%22}">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #161616;
    --surface2: #1e1e1e;
    --border: #2a2a2a;
    --accent: #f5a623;
    --accent2: #e8341a;
    --green: #2ecc71;
    --red: #e74c3c;
    --text: #f0f0f0;
    --muted: #888;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Sarabun', sans-serif;
    min-height: 100vh;
    background-image:
      radial-gradient(ellipse at 10% 10%, rgba(245,166,35,0.05) 0%, transparent 50%),
      radial-gradient(ellipse at 90% 90%, rgba(232,52,26,0.04) 0%, transparent 50%);
  }
  header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(22,22,22,0.95);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 3px; color: var(--accent); }
  .logo span { color: var(--text); font-size: 11px; display: block; font-family: 'Sarabun', sans-serif; font-weight: 300; letter-spacing: 1px; margin-top: -3px; }
  .month-nav { display: flex; align-items: center; gap: 12px; }
  .month-nav button {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    width: 34px; height: 34px; border-radius: 50%; cursor: pointer; font-size: 18px;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .month-nav button:hover { background: var(--accent); color: #000; border-color: var(--accent); }
  #current-month-label { font-size: 15px; font-weight: 600; min-width: 150px; text-align: center; }

  main { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

  /* Summary */
  .summary-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 24px; }
  @media(max-width:600px){ .summary-grid { grid-template-columns: 1fr; } }
  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; position: relative; overflow: hidden;
  }
  .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .card.income::before { background: var(--green); }
  .card.expense::before { background: var(--red); }
  .card.profit::before { background: var(--accent); }
  .card-label { font-size: 11px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; }
  .card-amount { font-family: 'Bebas Neue', sans-serif; font-size: 34px; letter-spacing: 1px; line-height: 1; }
  .card.income .card-amount { color: var(--green); }
  .card.expense .card-amount { color: var(--red); }
  .card.profit .card-amount { color: var(--accent); }
  .card-sub { font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* Form */
  .form-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
  .form-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; color: var(--accent); margin-bottom: 18px; }
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; align-items: end; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  input, select, textarea {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    border-radius: 8px; padding: 10px 12px; font-size: 14px; font-family: 'Sarabun', sans-serif;
    transition: border-color 0.2s; width: 100%;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
  textarea { resize: none; height: 42px; }

  .tab-toggle { display: flex; background: var(--surface2); border-radius: 8px; padding: 3px; gap: 3px; border: 1px solid var(--border); }
  .tab-btn { flex: 1; padding: 8px 10px; border: none; background: transparent; color: var(--muted); border-radius: 6px; cursor: pointer; font-family: 'Sarabun', sans-serif; font-size: 13px; font-weight: 600; transition: all 0.2s; }
  .tab-btn.active-income { background: var(--green); color: #000; }
  .tab-btn.active-expense { background: var(--red); color: #fff; }

  .submit-btn {
    background: var(--accent); color: #000; border: none; border-radius: 8px;
    padding: 11px 20px; font-family: 'Bebas Neue', sans-serif; font-size: 17px;
    letter-spacing: 2px; cursor: pointer; transition: all 0.2s; white-space: nowrap; width: 100%;
  }
  .submit-btn:hover { background: var(--accent2); color: #fff; }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Slip Upload */
  .slip-upload-area {
    border: 2px dashed var(--border); border-radius: 8px; padding: 16px;
    text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
    background: var(--surface2);
  }
  .slip-upload-area:hover { border-color: var(--accent); }
  .slip-upload-area input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; }
  .slip-preview { width: 100%; max-height: 120px; object-fit: cover; border-radius: 6px; margin-top: 8px; display: none; }
  .slip-label { font-size: 12px; color: var(--muted); }

  /* Category chart */
  .cat-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
  .cat-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px; color: var(--accent); margin-bottom: 14px; }
  .cat-row { display: grid; grid-template-columns: 120px 1fr 80px; align-items: center; gap: 10px; margin-bottom: 8px; }
  .cat-label { font-size: 12px; color: var(--muted); }
  .cat-bar-bg { background: var(--surface2); border-radius: 4px; height: 7px; }
  .cat-bar { height: 7px; border-radius: 4px; background: var(--red); transition: width 0.6s ease; }
  .cat-amount { font-size: 12px; font-weight: 600; text-align: right; }

  /* Chart Section */
  .chart-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
  .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
  .chart-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; color: var(--accent); }
  .chart-tabs { display: flex; gap: 6px; }
  .chart-tab {
    background: var(--surface2); border: 1px solid var(--border); color: var(--muted);
    border-radius: 6px; padding: 5px 12px; cursor: pointer; font-family: 'Sarabun', sans-serif;
    font-size: 12px; font-weight: 600; transition: all 0.2s;
  }
  .chart-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
  .chart-wrapper { position: relative; height: 240px; }
  .chart-summary-row {
    display: grid; grid-template-columns: repeat(6,1fr); gap: 6px; margin-top: 14px;
  }
  @media(max-width:600px){ .chart-summary-row { grid-template-columns: repeat(3,1fr); } }
  .chart-month-cell { text-align: center; background: var(--surface2); border-radius: 6px; padding: 8px 4px; }
  .chart-month-name { font-size: 10px; color: var(--muted); margin-bottom: 3px; }
  .chart-month-income { font-size: 11px; color: var(--green); font-weight: 600; }
  .chart-month-expense { font-size: 11px; color: var(--red); font-weight: 600; }
  .chart-month-profit { font-size: 10px; color: var(--muted); margin-top: 2px; }

  /* Status bar */
  .status-bar {
    display: flex; align-items: center; gap: 8px; padding: 10px 16px;
    background: var(--surface2); border-radius: 8px; margin-bottom: 24px;
    font-size: 13px;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  .status-dot.loading { background: var(--accent); }
  .status-dot.error { background: var(--red); animation: none; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* Loading overlay */
  .loading-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 999; display: none;
  }
  .loading-spinner {
    width: 48px; height: 48px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 20px; font-size: 14px; z-index: 9999;
    transition: transform 0.3s; white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error { border-color: var(--red); color: var(--red); }

  /* Year grid */
  .year-section { margin-bottom: 24px; }
  .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px; color: var(--accent); margin-bottom: 12px; }
  .year-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
  @media(max-width:500px){ .year-grid { grid-template-columns: repeat(3,1fr); } }
  .month-cell {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s;
  }
  .month-cell:hover { border-color: var(--accent); }
  .month-cell.current { border-color: var(--accent); }
  .month-cell.profit-pos { border-left: 3px solid var(--green); }
  .month-cell.profit-neg { border-left: 3px solid var(--red); }
  .month-cell-name { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .month-cell-profit { font-family: 'Bebas Neue', sans-serif; font-size: 16px; }

  /* Slip modal */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 500; padding: 20px; }
  .modal.show { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; max-width: 400px; width: 100%; }
  .modal-img { width: 100%; border-radius: 8px; max-height: 70vh; object-fit: contain; }
  .modal-close { margin-top: 12px; width: 100%; padding: 10px; background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; cursor: pointer; font-family: 'Sarabun', sans-serif; font-size: 14px; }
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<div class="toast" id="toast"></div>

<div class="modal" id="slip-modal">
  <div class="modal-box">
    <img class="modal-img" id="modal-img" src="" alt="slip">
    <button class="modal-close" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<header>
  <div class="logo">
    KMO RACK BAR
    <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</span>
  </div>
  <div class="month-nav">
    <button onclick="changeMonth(-1)">‚Äπ</button>
    <div id="current-month-label">‚Äî</div>
    <button onclick="changeMonth(1)">‚Ä∫</button>
  </div>
</header>

<main>

  <!-- Status -->
  <div class="status-bar">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
  </div>

  <!-- Summary -->
  <div class="summary-grid">
    <div class="card income">
      <div class="card-label">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
      <div class="card-amount" id="total-income">0</div>
      <div class="card-sub" id="income-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    </div>
    <div class="card expense">
      <div class="card-label">üîß ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div class="card-amount" id="total-expense">0</div>
      <div class="card-sub" id="expense-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    </div>
    <div class="card profit">
      <div class="card-label">üìä ‡∏Å‡∏≥‡πÑ‡∏£ / ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
      <div class="card-amount" id="total-profit">0</div>
      <div class="card-sub" id="profit-status">‚Äî</div>
    </div>
  </div>

  <!-- Add Form -->
  <div class="form-section">
    <div class="form-title">‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    <div class="form-grid">
      <div class="form-group">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
        <div class="tab-toggle">
          <button class="tab-btn active-income" id="btn-income" onclick="setType('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
          <button class="tab-btn" id="btn-expense" onclick="setType('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
        </div>
      </div>
      <div class="form-group">
        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <input type="text" id="input-desc" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á Honda Wave" />
      </div>
      <div class="form-group">
        <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
        <select id="input-cat" onchange="handleCatChange()">
          <option value="‡∏á‡∏≤‡∏ô‡∏Ñ‡∏±‡∏™‡∏ï‡∏≠‡∏°">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏±‡∏™‡∏ï‡∏≠‡∏°</option>
          <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡∏•‡∏ä‡∏ö‡∏≤‡∏£‡πå">‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡∏•‡∏ä‡∏ö‡∏≤‡∏£‡πå</option>
          <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á">‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á</option>
          <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏ó‡πâ‡∏≤‡∏¢">‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏ó‡πâ‡∏≤‡∏¢</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="form-group" id="other-cat-group" style="display:none">
        <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
        <input type="text" id="input-other-cat" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà..." />
      </div>
      <div class="form-group">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" id="input-amount" placeholder="0" min="0" />
      </div>
      <div class="form-group">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="input-date" />
      </div>
      <div class="form-group">
        <label>‡∏™‡∏•‡∏¥‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
        <div class="slip-upload-area" id="slip-area">
          <input type="file" id="input-slip" accept="image/*" onchange="handleSlipChange()" capture="environment">
          <div class="slip-label" id="slip-label">üìé ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
          <img class="slip-preview" id="slip-preview" />
        </div>
      </div>
      <div class="form-group">
        <label>&nbsp;</label>
        <button class="submit-btn" id="submit-btn" onclick="addTransaction()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Category Breakdown -->
  <div class="cat-section" id="cat-section" style="display:none">
    <div class="cat-title">üè∑ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
    <div id="cat-bars"></div>
  </div>

  <!-- Chart -->
  <div class="chart-section">
    <div class="chart-header">
      <div class="chart-title">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div>
      <div class="chart-tabs">
        <button class="chart-tab active" onclick="setChartMode('both', this)">‡∏£‡∏ß‡∏°</button>
        <button class="chart-tab" onclick="setChartMode('income', this)">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
        <button class="chart-tab" onclick="setChartMode('expense', this)">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
      </div>
    </div>
    <div class="chart-wrapper">
      <canvas id="main-chart"></canvas>
    </div>
    <div class="chart-summary-row" id="chart-summary"></div>
  </div>

  <!-- Year Grid -->
  <div class="year-section">
    <div class="section-title">üìÖ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° <span id="year-label" style="font-size:14px;font-family:Sarabun;font-weight:300;color:var(--muted)"></span></div>
    <div class="year-grid" id="year-grid"></div>
  </div>

  <!-- Transaction List replaced by recent items -->
  <div class="chart-section">
    <div class="chart-header">
      <div class="chart-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="chart-tabs">
        <button class="chart-tab active" onclick="setFilter('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="chart-tab" onclick="setFilter('income', this)">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
        <button class="chart-tab" onclick="setFilter('expense', this)">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
      </div>
    </div>
    <div id="tx-list"></div>
  </div>

</main>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz15GoLWtrRjJEafL3tvAQylk_PnT6XI9jFrerlH4hhNGz1LxKR4jINi17lR2gIy9a2/exec';

const MONTHS = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
const MONTHS_SHORT = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];

let transactions = [];
let currentType = 'income';
let currentFilter = 'all';
let currentDate = new Date();
currentDate.setDate(1);
let chartMode = 'both';
let mainChart = null;
let slipFile = null;
let slipBase64 = null;

// Init
document.getElementById('input-date').valueAsDate = new Date();
document.getElementById('year-label').textContent = currentDate.getFullYear() + 543;
loadTransactions();

function jsonpFetch(url) {
  return new Promise((resolve, reject) => {
    const cbName = 'cb_' + Date.now();
    const script = document.createElement('script');
    const fullUrl = url + '?callback=' + cbName + '&t=' + Date.now();
    window[cbName] = (data) => {
      delete window[cbName];
      try { document.head.removeChild(script); } catch(e) {}
      resolve(data);
    };
    script.onerror = () => {
      delete window[cbName];
      try { document.head.removeChild(script); } catch(e) {}
      reject(new Error('JSONP failed'));
    };
    script.src = fullUrl;
    document.head.appendChild(script);
    setTimeout(() => {
      if (window[cbName]) {
        delete window[cbName];
        try { document.head.removeChild(script); } catch(e) {}
        reject(new Error('timeout'));
      }
    }, 12000);
  });
}

async function apiCall(data) {
  await fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(data)
  });
  return { success: true };
}

async function loadTransactions() {
  setStatus('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
  try {
    const json = await jsonpFetch(SCRIPT_URL);
    if (json.success) {
      transactions = (json.data || []).map(t => ({
        ...t,
        amount: parseFloat(t.amount) || 0,
        id: t.id ? t.id.toString() : String(Date.now())
      }));
      localStorage.setItem('kmo_tx_backup', JSON.stringify(transactions));
      setStatus('ok', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÅ‡∏•‡πâ‡∏ß ‚úì');
      render();
    } else {
      throw new Error('Load failed');
    }
  } catch(e) {
    console.error('Load error:', e);
    setStatus('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä');
    transactions = JSON.parse(localStorage.getItem('kmo_tx_backup') || '[]');
    render();
  }
}

function setStatus(type, msg) {
  const dot = document.getElementById('status-dot');
  dot.className = 'status-dot ' + (type === 'loading' ? 'loading' : type === 'error' ? 'error' : '');
  document.getElementById('status-text').textContent = msg;
}

function showLoading(v) { document.getElementById('loading-overlay').style.display = v ? 'flex' : 'none'; }

function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function fmt(n) { return Number(n).toLocaleString('th-TH'); }

function setType(t) {
  currentType = t;
  document.getElementById('btn-income').className = 'tab-btn ' + (t==='income'?'active-income':'');
  document.getElementById('btn-expense').className = 'tab-btn ' + (t==='expense'?'active-expense':'');
  const cat = document.getElementById('input-cat');
  if (t === 'income') {
    cat.innerHTML = `
      <option value="‡∏á‡∏≤‡∏ô‡∏Ñ‡∏±‡∏™‡∏ï‡∏≠‡∏°">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏±‡∏™‡∏ï‡∏≠‡∏°</option>
      <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡∏•‡∏ä‡∏ö‡∏≤‡∏£‡πå">‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡∏•‡∏ä‡∏ö‡∏≤‡∏£‡πå</option>
      <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á">‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏Ç‡πâ‡∏≤‡∏á</option>
      <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏ó‡πâ‡∏≤‡∏¢">‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡πá‡∏Ñ‡∏ó‡πâ‡∏≤‡∏¢</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>`;
  } else {
    cat.innerHTML = `
      <option value="‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏</option>
      <option value="‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>
      <option value="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</option>
      <option value="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü</option>
      <option value="‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á">‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á</option>
      <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>`;
  }
  handleCatChange();
}

function handleCatChange() {
  const val = document.getElementById('input-cat').value;
  const grp = document.getElementById('other-cat-group');
  grp.style.display = val === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? '' : 'none';
  if (val !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') document.getElementById('input-other-cat').value = '';
}

function handleSlipChange() {
  const file = document.getElementById('input-slip').files[0];
  if (!file) return;
  slipFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    slipBase64 = e.target.result.split(',')[1];
    const preview = document.getElementById('slip-preview');
    preview.src = e.target.result;
    preview.style.display = 'block';
    document.getElementById('slip-label').textContent = '‚úÖ ' + file.name;
  };
  reader.readAsDataURL(file);
}

async function addTransaction() {
  const desc = document.getElementById('input-desc').value.trim();
  const amount = parseFloat(document.getElementById('input-amount').value);
  let cat = document.getElementById('input-cat').value;
  const date = document.getElementById('input-date').value;

  if (cat === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
    const other = document.getElementById('input-other-cat').value.trim();
    if (other) cat = other;
  }

  if (!desc) return showToast('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞!', 'error');
  if (!amount || amount <= 0) return showToast('‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞!', 'error');
  if (!date) return showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞!', 'error');

  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  showLoading(true);

  try {
    let slipUrl = '';

    // Upload slip if any
    if (slipBase64 && slipFile) {
      const upRes = await apiCall({
        action: 'uploadSlip',
        fileData: slipBase64,
        mimeType: slipFile.type,
        fileName: `slip_${Date.now()}.${slipFile.name.split('.').pop()}`
      });
      if (upRes.success) slipUrl = upRes.url;
    }

    const res = await apiCall({ action: 'addTransaction', type: currentType, desc, cat, amount, date, slipUrl });

    if (res.success) {
      // Add to local list immediately
      transactions.unshift({ id: res.id, type: currentType, desc, cat, amount, date, slipUrl });
      localStorage.setItem('kmo_tx_backup', JSON.stringify(transactions));

      // Reset form
      document.getElementById('input-desc').value = '';
      document.getElementById('input-amount').value = '';
      document.getElementById('input-slip').value = '';
      document.getElementById('slip-preview').style.display = 'none';
      document.getElementById('slip-label').textContent = 'üìé ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
      document.getElementById('other-cat-group').style.display = 'none';
      slipFile = null; slipBase64 = null;

      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úì');
      render();
    }
  } catch(e) {
    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞', 'error');
  }

  showLoading(false);
  btn.disabled = false;
  btn.textContent = '+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
}

async function deleteTransaction(id) {
  if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  showLoading(true);
  try {
    await apiCall({ action: 'deleteTransaction', id });
    transactions = transactions.filter(t => t.id?.toString() !== id?.toString());
    localStorage.setItem('kmo_tx_backup', JSON.stringify(transactions));
    showToast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    render();
  } catch(e) {
    showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
  }
  showLoading(false);
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('#tx-list').forEach(()=>{});
  el.closest('.chart-tabs').querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  render();
}

function setChartMode(m, el) {
  chartMode = m;
  el.closest('.chart-tabs').querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderChart();
}

function changeMonth(dir) {
  currentDate.setMonth(currentDate.getMonth() + dir);
  document.getElementById('year-label').textContent = currentDate.getFullYear() + 543;
  render();
}

function getMonthTx(m, y) {
  return transactions.filter(t => {
    const d = new Date(t.date);
    return d.getMonth() === m && d.getFullYear() === y;
  });
}

function getYearData(y) {
  return MONTHS.map((_, i) => {
    const tx = getMonthTx(i, y);
    const income = tx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const expense = tx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    return { income, expense, profit: income - expense, count: tx.length };
  });
}

function render() {
  const m = currentDate.getMonth();
  const y = currentDate.getFullYear();
  document.getElementById('current-month-label').textContent = MONTHS[m] + ' ' + (y+543);

  const monthTx = getMonthTx(m, y);
  const income = monthTx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = monthTx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const profit = income - expense;

  document.getElementById('total-income').textContent = fmt(income);
  document.getElementById('total-expense').textContent = fmt(expense);
  document.getElementById('total-profit').textContent = (profit>=0?'+':'')+fmt(profit);
  document.getElementById('income-count').textContent = monthTx.filter(t=>t.type==='income').length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  document.getElementById('expense-count').textContent = monthTx.filter(t=>t.type==='expense').length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  document.getElementById('profit-status').textContent = profit >= 0 ? '‚úÖ ‡∏Å‡∏≥‡πÑ‡∏£' : '‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô';

  // Category
  const expTx = monthTx.filter(t=>t.type==='expense');
  const cats = {};
  expTx.forEach(t => { cats[t.cat] = (cats[t.cat]||0)+t.amount; });
  const catSec = document.getElementById('cat-section');
  if (Object.keys(cats).length > 0) {
    catSec.style.display = '';
    const maxV = Math.max(...Object.values(cats));
    document.getElementById('cat-bars').innerHTML = Object.entries(cats)
      .sort((a,b)=>b[1]-a[1])
      .map(([cat, val]) => `<div class="cat-row">
        <div class="cat-label">${cat}</div>
        <div class="cat-bar-bg"><div class="cat-bar" style="width:${(val/maxV*100).toFixed(1)}%"></div></div>
        <div class="cat-amount">${fmt(val)}</div>
      </div>`).join('');
  } else catSec.style.display = 'none';

  // Year grid
  const yearData = getYearData(y);
  document.getElementById('year-grid').innerHTML = MONTHS_SHORT.map((name, i) => {
    const d = yearData[i];
    const isCur = i === m;
    const cls = d.count === 0 ? '' : d.profit >= 0 ? 'profit-pos' : 'profit-neg';
    return `<div class="month-cell ${cls} ${isCur?'current':''}" onclick="goMonth(${i})">
      <div class="month-cell-name">${name}</div>
      <div class="month-cell-profit" style="color:${d.count===0?'#444':d.profit>=0?'#2ecc71':'#e74c3c'}">${d.count===0?'‚Äî':(d.profit>=0?'+':'')+fmt(d.profit)}</div>
    </div>`;
  }).join('');

  // Chart
  renderChart();

  // TX List
  let filtered = monthTx.filter(t => currentFilter==='all' || t.type===currentFilter);
  filtered.sort((a,b) => new Date(b.date)-new Date(a.date));
  const txList = document.getElementById('tx-list');
  if (filtered.length === 0) {
    txList.innerHTML = `<div style="text-align:center;padding:48px 20px;color:var(--muted)"><div style="font-size:40px;margin-bottom:10px;opacity:.3">üèçÔ∏è</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>`;
  } else {
    txList.innerHTML = filtered.map(t => {
      const d = new Date(t.date);
      const dateStr = `${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()+543}`;
      const slipBtn = t.slipUrl ? `<button onclick="openSlip('${t.slipUrl}')" style="background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px;">üìé ‡∏™‡∏•‡∏¥‡∏õ</button>` : '';
      return `<div style="display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:14px;padding:14px 20px;border-bottom:1px solid var(--border);transition:background .15s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
        <div style="width:9px;height:9px;border-radius:50%;background:${t.type==='income'?'var(--green)':'var(--red)'};box-shadow:0 0 6px ${t.type==='income'?'rgba(46,204,113,.5)':'rgba(231,76,60,.5)'}"></div>
        <div>
          <div style="font-size:14px;font-weight:600">${t.desc}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">${dateStr} ¬∑ <span style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:2px 8px;font-size:10px">${t.cat}</span> ${slipBtn}</div>
        </div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:${t.type==='income'?'var(--green)':'var(--red)'}">
          ${t.type==='income'?'+':'-'}${fmt(t.amount)}
        </div>
        <button onclick="deleteTransaction('${t.id}')" style="background:none;border:none;color:var(--border);cursor:pointer;font-size:16px;padding:4px;border-radius:4px;transition:color .2s" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--border)'">‚úï</button>
      </div>`;
    }).join('');
  }
}

function renderChart() {
  const y = currentDate.getFullYear();
  const yearData = getYearData(y);
  const incomes = yearData.map(d => d.income);
  const expenses = yearData.map(d => d.expense);

  const ctx = document.getElementById('main-chart').getContext('2d');
  if (mainChart) mainChart.destroy();

  let datasets = [];
  if (chartMode === 'both' || chartMode === 'income') {
    datasets.push({
      label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', data: incomes,
      borderColor: '#2ecc71', backgroundColor: 'rgba(46,204,113,0.08)',
      borderWidth: 2, pointBackgroundColor: '#2ecc71', pointRadius: 4,
      tension: 0.4, fill: chartMode === 'income'
    });
  }
  if (chartMode === 'both' || chartMode === 'expense') {
    datasets.push({
      label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', data: expenses,
      borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.08)',
      borderWidth: 2, pointBackgroundColor: '#e74c3c', pointRadius: 4,
      tension: 0.4, fill: chartMode === 'expense'
    });
  }

  mainChart = new Chart(ctx, {
    type: 'line',
    data: { labels: MONTHS_SHORT, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#888', font: { family: 'Sarabun' } } } },
      scales: {
        x: { grid: { color: '#1e1e1e' }, ticks: { color: '#888', font: { family: 'Sarabun', size: 11 } } },
        y: { grid: { color: '#1e1e1e' }, ticks: { color: '#888', font: { family: 'Sarabun', size: 11 }, callback: v => fmt(v) } }
      }
    }
  });

  // Summary row
  document.getElementById('chart-summary').innerHTML = MONTHS_SHORT.map((name, i) => {
    const d = yearData[i];
    const pr = d.profit;
    return `<div class="chart-month-cell">
      <div class="chart-month-name">${name}</div>
      ${chartMode !== 'expense' ? `<div class="chart-month-income">+${fmt(d.income)}</div>` : ''}
      ${chartMode !== 'income' ? `<div class="chart-month-expense">-${fmt(d.expense)}</div>` : ''}
      ${chartMode === 'both' ? `<div class="chart-month-profit" style="color:${pr>=0?'var(--green)':'var(--red)'}">${pr>=0?'+':''}${fmt(pr)}</div>` : ''}
    </div>`;
  }).join('');
}

function goMonth(i) {
  currentDate.setMonth(i);
  render();
}

function openSlip(url) {
  document.getElementById('modal-img').src = url;
  document.getElementById('slip-modal').classList.add('show');
}
function closeModal() { document.getElementById('slip-modal').classList.remove('show'); }
</script>
</body>
</html>
